import tkinter as tk
from tkinter import messagebox
import webbrowser
import os
import re
from urllib.parse import urlparse
from datetime import datetime

FILENAME = "youtube_links.txt"

# ---------------- helpers ----------------
def sanitize_link(link: str) -> str:
    link = link.strip()
    if not link:
        return ""
    if link.startswith("www."):
        link = "https://" + link
    if link.startswith("youtu.be/") or link.startswith("youtube.com/") and not link.startswith("http"):
        link = "https://" + link
    if not link.startswith("http"):
        link = "https://" + link
    return link

def extract_short_title_from_url(url: str) -> str:
    try:
        m = re.search(r"v=([^&]+)", url)
        if not m:
            m = re.search(r"youtu\.be/([^?&/]+)", url)
        if not m:
            m = re.search(r"youtube\.com/embed/([^?&/]+)", url)
        if m:
            return f"Video {m.group(1)}"
        parsed = urlparse(url)
        path = parsed.path or ""
        last = path.rstrip("/").split("/")[-1]
        if last:
            return last
        return parsed.netloc or "Untitled"
    except Exception:
        return "Untitled"

def format_display(title, link, watched, date):
    trophy = "üèÜ " if watched else ""
    return f"{trophy}{title}  ‚Üí  {link}  ({date})"

# ---------------- storage ----------------
def load_links():
    if os.path.exists(FILENAME):
        with open(FILENAME, "r", encoding="utf-8") as f:
            lines = [line.strip() for line in f.readlines() if line.strip()]
            links_data = []
            for line in lines:
                parts = line.split("|")
                if len(parts) == 4:
                    title, link, watched, date = parts
                    links_data.append([title.strip(), link.strip(), watched == "1", date.strip()])
                elif "|" in line:
                    # old format: title|link
                    title, link = line.split("|", 1)
                    date = datetime.now().strftime("%Y-%m-%d %H:%M")
                    links_data.append([title.strip(), link.strip(), False, date])
                else:
                    # very old format: link only
                    link = line.strip()
                    title = extract_short_title_from_url(link)
                    date = datetime.now().strftime("%Y-%m-%d %H:%M")
                    links_data.append([title, link, False, date])
            return links_data
    return []

def save_links():
    with open(FILENAME, "w", encoding="utf-8") as f:
        for title, link, watched, date in links:
            f.write(f"{title}|{link}|{1 if watched else 0}|{date}\n")

# ---------------- actions ----------------
def add_link(title=None, link=None):
    if title is None:
        title = title_entry.get().strip()
    if link is None:
        link = link_entry.get().strip()

    link = sanitize_link(link)
    if not (title and link):
        messagebox.showwarning("Warning", "Please enter both Title and Link (or paste a link).")
        return

    date = datetime.now().strftime("%Y-%m-%d %H:%M")
    links.append([title, link, False, date])
    refresh_listbox()
    save_links()
    title_entry.delete(0, tk.END)
    link_entry.delete(0, tk.END)

def paste_to_entry(event=None):
    try:
        clip = root.clipboard_get()
    except tk.TclError:
        messagebox.showwarning("Warning", "Clipboard is empty or unavailable.")
        return "break"
    clip = clip.strip()
    if not clip:
        messagebox.showwarning("Warning", "Clipboard is empty.")
        return "break"
    link = sanitize_link(clip)
    link_entry.delete(0, tk.END)
    link_entry.insert(0, link)
    if not title_entry.get().strip():
        title_entry.delete(0, tk.END)
        title_entry.insert(0, extract_short_title_from_url(link))
    return "break"

def open_link():
    try:
        indices = listbox.curselection()
        if not indices:
            raise Exception()
        for i in indices:
            _, link, _, _ = filtered_links[i]
            webbrowser.open(link)
    except Exception:
        messagebox.showwarning("Warning", "Please select at least one link!")

def delete_link():
    try:
        indices = list(listbox.curselection())
        if not indices:
            raise Exception()
        indices.sort(reverse=True)
        for i in indices:
            real_index = links.index(filtered_links[i])
            links.pop(real_index)
        save_links()
        refresh_listbox()
    except Exception:
        messagebox.showwarning("Warning", "Please select at least one link!")

def mark_watched():
    try:
        indices = listbox.curselection()
        if not indices:
            raise Exception()
        for i in indices:
            real_index = links.index(filtered_links[i])
            links[real_index][2] = True
        save_links()
        refresh_listbox()
    except Exception:
        messagebox.showwarning("Warning", "Please select at least one link!")

def search_links(*args):
    query = search_var.get().strip().lower()
    listbox.delete(0, tk.END)
    global filtered_links
    if query:
        filtered_links = [item for item in links if query in item[0].lower()]
    else:
        filtered_links = links[:]
    for t, l, w, d in filtered_links:
        listbox.insert(tk.END, format_display(t, l, w, d))

def refresh_listbox():
    search_links()

# ---------------- GUI ----------------
root = tk.Tk()
root.title("YouTube Watchlist")
root.geometry("800x580")
root.resizable(False, False)

# Dark theme
bg_color = "#121212"
fg_color = "#ffffff"
entry_bg = "#1e1e1e"
btn_green = "#4CAF50"
btn_blue = "#2196F3"
btn_red = "#f44336"
btn_gray = "#6a6a6a"
btn_gold = "#FFD700"

root.configure(bg=bg_color)

# Title field (center)
title_frame = tk.Frame(root, bg=bg_color)
title_frame.pack(pady=6)
title_label = tk.Label(title_frame, text="Title:", bg=bg_color, fg=fg_color)
title_label.pack()
title_entry = tk.Entry(title_frame, width=50, bg=entry_bg, fg=fg_color, insertbackground=fg_color, justify="center")
title_entry.pack()

# Link field (center)
link_frame = tk.Frame(root, bg=bg_color)
link_frame.pack(pady=6)
link_label = tk.Label(link_frame, text="YouTube Link:", bg=bg_color, fg=fg_color)
link_label.pack()
link_entry = tk.Entry(link_frame, width=50, bg=entry_bg, fg=fg_color, insertbackground=fg_color, justify="center")
link_entry.pack()

# Buttons row
btn_frame = tk.Frame(root, bg=bg_color)
btn_frame.pack(pady=10)
add_button = tk.Button(btn_frame, text="Add", command=add_link, bg=btn_green, fg="white", width=12)
add_button.pack(side=tk.LEFT, padx=6)
paste_button = tk.Button(btn_frame, text="Paste", command=paste_to_entry, bg=btn_gray, fg="white", width=12)
paste_button.pack(side=tk.LEFT, padx=6)
watch_button = tk.Button(btn_frame, text="Watch", command=open_link, bg=btn_blue, fg="white", width=12)
watch_button.pack(side=tk.LEFT, padx=6)
delete_button = tk.Button(btn_frame, text="Delete", command=delete_link, bg=btn_red, fg="white", width=12)
delete_button.pack(side=tk.LEFT, padx=6)
mark_button = tk.Button(btn_frame, text="Mark as Watched", command=mark_watched, bg=btn_gold, fg="black", width=15)
mark_button.pack(side=tk.LEFT, padx=6)

# Search bar
search_frame = tk.Frame(root, bg=bg_color)
search_frame.pack(pady=6)
search_label = tk.Label(search_frame, text="Search by Title:", bg=bg_color, fg=fg_color)
search_label.pack()
search_var = tk.StringVar()
search_var.trace("w", search_links)
search_entry = tk.Entry(search_frame, textvariable=search_var, width=50, bg=entry_bg, fg=fg_color, insertbackground=fg_color, justify="center")
search_entry.pack()

# Listbox
listbox = tk.Listbox(root, width=110, height=18, bg=entry_bg, fg=fg_color, selectmode=tk.EXTENDED, selectbackground="#333")
listbox.pack(pady=(6,12))

# Load existing links
links = load_links()
filtered_links = links[:]
refresh_listbox()

root.mainloop()
