import sys
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout, QLineEdit,
    QPushButton, QListWidget, QListWidgetItem, QMessageBox, QLabel
)
from PyQt6.QtGui import QIcon, QPixmap, QFont
from PyQt6.QtCore import Qt, QSize
from urllib.parse import urlparse, parse_qs
import re
import requests
from datetime import datetime
import webbrowser
import os

FILENAME = "youtube_links_final.txt"
THUMB_DIR = "thumbnails"

# ---------------- Helpers ----------------
def sanitize_link(link: str) -> str:
    link = link.strip()
    if not link:
        return ""
    if link.startswith("www."):
        link = "https://" + link
    if link.startswith("youtu.be/") or link.startswith("youtube.com/") and not link.startswith("http"):
        link = "https://" + link
    if not link.startswith("http"):
        link = "https://" + link
    return link

def get_video_id(link):
    parsed = urlparse(link)
    if "youtu.be" in parsed.netloc:
        return parsed.path.lstrip("/")
    if "youtube" in parsed.netloc:
        qs = parse_qs(parsed.query)
        if "v" in qs:
            return qs["v"][0]
    if re.match(r"^[A-Za-z0-9_-]{11}$", link):
        return link
    return None

def download_thumbnail(video_id):
    if not os.path.exists(THUMB_DIR):
        os.makedirs(THUMB_DIR)
    thumbs = ["maxresdefault.jpg","sddefault.jpg","hqdefault.jpg","mqdefault.jpg","default.jpg"]
    local_path = os.path.join(THUMB_DIR, f"{video_id}.jpg")
    if os.path.exists(local_path):
        return local_path
    for t in thumbs:
        url = f"https://i.ytimg.com/vi/{video_id}/{t}"
        try:
            r = requests.get(url, timeout=5)
            if r.status_code == 200:
                with open(local_path, "wb") as f:
                    f.write(r.content)
                return local_path
        except:
            continue
    return None

# ---------------- Custom Widget ----------------
class VideoItem(QWidget):
    def __init__(self, title, date, watched, thumb_file):
        super().__init__()
        layout = QHBoxLayout()
        layout.setContentsMargins(8, 8, 8, 8)

        # ØµÙˆØ±Ø© Ù…ØµØºØ±Ø©
        if thumb_file and os.path.exists(thumb_file):
            pixmap = QPixmap(thumb_file).scaled(200, 120, Qt.AspectRatioMode.KeepAspectRatio, Qt.TransformationMode.SmoothTransformation)
        else:
            pixmap = QPixmap(200, 120)
            pixmap.fill(Qt.GlobalColor.black)
        thumb_label = QLabel()
        thumb_label.setPixmap(pixmap)
        thumb_label.setFixedSize(200, 120)
        layout.addWidget(thumb_label)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        info_layout = QVBoxLayout()
        info_layout.setAlignment(Qt.AlignmentFlag.AlignRight)

        title_label = QLabel(title)
        title_label.setFont(QFont("Arial", 12, QFont.Weight.Bold))
        title_label.setStyleSheet("color: white;")

        date_label = QLabel(f"ğŸ“… {date}")
        date_label.setStyleSheet("color: #BBBBBB; font-size: 11px;")

        status_label = QLabel("âœ… ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©" if watched else "âŒ Ù„Ù… ØªÙØ´Ø§Ù‡Ø¯ Ø¨Ø¹Ø¯")
        status_label.setStyleSheet("color: #00FF99;" if watched else "color: #FF5555; font-size: 12px;")

        info_layout.addWidget(title_label)
        info_layout.addWidget(date_label)
        info_layout.addWidget(status_label)

        layout.addLayout(info_layout)

        # Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ§Ø±Ø¯
        self.setLayout(layout)
        self.setStyleSheet("""
            QWidget {
                background-color: #1e1e1e;
                border: 2px solid #333;
                border-radius: 12px;
            }
        """)

# ---------------- Main App ----------------
class YouTubeWatchlist(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨")
        self.setGeometry(100, 100, 1100, 750)
        self.setStyleSheet("background-color: #121212; color: white;")
        self.links = []
        self.load_links()
        self.init_ui()

    def init_ui(self):
        main_layout = QVBoxLayout()

        # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø§Ø¨Ø·
        entry_layout = QHBoxLayout()
        self.title_entry = QLineEdit()
        self.title_entry.setPlaceholderText("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
        self.title_entry.setStyleSheet("background-color: #1e1e1e; color: white;")
        self.title_entry.setAlignment(Qt.AlignmentFlag.AlignRight)

        self.link_entry = QLineEdit()
        self.link_entry.setPlaceholderText("Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨")
        self.link_entry.setStyleSheet("background-color: #1e1e1e; color: white;")
        self.link_entry.setAlignment(Qt.AlignmentFlag.AlignRight)

        entry_layout.addWidget(self.title_entry)
        entry_layout.addWidget(self.link_entry)
        main_layout.addLayout(entry_layout)

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btn_layout = QHBoxLayout()
        add_btn = QPushButton("â• Ø¥Ø¶Ø§ÙØ©")
        add_btn.setStyleSheet("background-color: #4CAF50; color: white;")
        add_btn.clicked.connect(self.add_link)

        paste_btn = QPushButton("ğŸ“‹ Ù„ØµÙ‚")
        paste_btn.setStyleSheet("background-color: #6a6a6a; color: white;")
        paste_btn.clicked.connect(self.paste_clipboard)

        watch_btn = QPushButton("â–¶ï¸ Ù…Ø´Ø§Ù‡Ø¯Ø©")
        watch_btn.setStyleSheet("background-color: #2196F3; color: white;")
        watch_btn.clicked.connect(self.watch_selected)

        delete_btn = QPushButton("ğŸ—‘ï¸ Ø­Ø°Ù")
        delete_btn.setStyleSheet("background-color: #f44336; color: white;")
        delete_btn.clicked.connect(self.delete_selected)

        mark_btn = QPushButton("âœ… ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ø´Ø§Ù‡Ø¯")
        mark_btn.setStyleSheet("background-color: #FFD700; color: black;")
        mark_btn.clicked.connect(self.mark_selected)

        btn_layout.addWidget(add_btn)
        btn_layout.addWidget(paste_btn)
        btn_layout.addWidget(watch_btn)
        btn_layout.addWidget(delete_btn)
        btn_layout.addWidget(mark_btn)
        main_layout.addLayout(btn_layout)

        # Ø§Ù„Ø¨Ø­Ø«
        self.search_entry = QLineEdit()
        self.search_entry.setPlaceholderText("ğŸ” Ø¨Ø­Ø« Ø¨Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ")
        self.search_entry.setStyleSheet("background-color: #1e1e1e; color: white;")
        self.search_entry.setAlignment(Qt.AlignmentFlag.AlignRight)
        self.search_entry.textChanged.connect(self.refresh_list)
        main_layout.addWidget(self.search_entry)

        # Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        self.list_widget = QListWidget()
        self.list_widget.setStyleSheet("""
            QListWidget {
                background-color: #121212;
                border: none;
            }
        """)
        self.list_widget.setSpacing(10)  # Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª
        main_layout.addWidget(self.list_widget)

        self.setLayout(main_layout)
        self.refresh_list()

    # ---------- Ø§Ù„ØªØ®Ø²ÙŠÙ† ----------
    def load_links(self):
        if os.path.exists(FILENAME):
            with open(FILENAME, "r", encoding="utf-8") as f:
                lines = [line.strip() for line in f.readlines() if line.strip()]
                for line in lines:
                    parts = line.split("|")
                    if len(parts) == 5:
                        title, link, watched, date, thumb_file = parts
                        self.links.append({
                            "title": title,
                            "link": link,
                            "watched": watched == "1",
                            "date": date,
                            "thumb_file": thumb_file
                        })

    def save_links(self):
        with open(FILENAME, "w", encoding="utf-8") as f:
            for item in self.links:
                f.write(f"{item['title']}|{item['link']}|{1 if item['watched'] else 0}|{item['date']}|{item['thumb_file']}\n")

    # ---------- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ----------
    def add_link(self):
        title = self.title_entry.text().strip()
        link = sanitize_link(self.link_entry.text())
        if not link:
            QMessageBox.warning(self, "ØªÙ†Ø¨ÙŠÙ‡", "âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·")
            return
        if not title:
            vid = get_video_id(link)
            title = f"ÙÙŠØ¯ÙŠÙˆ {vid}" if vid else "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"

        # Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØªÙ†Ø³ÙŠÙ‚ 12 Ø³Ø§Ø¹Ø© + ØµØ¨Ø§Ø­Ø§Ù‹/Ù…Ø³Ø§Ø¡Ù‹
        now = datetime.now()
        date_str = now.strftime("%Y-%m-%d %I:%M %p")
        date_str = date_str.replace("AM", "ØµØ¨Ø§Ø­Ø§Ù‹").replace("PM", "Ù…Ø³Ø§Ø¡Ù‹")

        vid = get_video_id(link)
        thumb_file = download_thumbnail(vid)
        self.links.append({
            "title": title,
            "link": link,
            "watched": False,
            "date": date_str,
            "thumb_file": thumb_file
        })
        self.title_entry.clear()
        self.link_entry.clear()
        self.save_links()
        self.refresh_list()

    def paste_clipboard(self):
        try:
            clip = QApplication.clipboard().text()
            if clip:
                self.link_entry.setText(clip)
                if not self.title_entry.text().strip():
                    vid = get_video_id(clip)
                    self.title_entry.setText(f"ÙÙŠØ¯ÙŠÙˆ {vid}" if vid else "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†")
        except:
            pass

    def delete_selected(self):
        selected = self.list_widget.selectedItems()
        for item in selected:
            idx = self.list_widget.row(item)
            self.links.pop(idx)
        self.save_links()
        self.refresh_list()

    def mark_selected(self):
        selected = self.list_widget.selectedItems()
        for item in selected:
            idx = self.list_widget.row(item)
            self.links[idx]["watched"] = True
        self.save_links()
        self.refresh_list()

    def watch_selected(self):
        selected = self.list_widget.selectedItems()
        for item in selected:
            idx = self.list_widget.row(item)
            webbrowser.open(self.links[idx]["link"])

    def refresh_list(self):
        query = self.search_entry.text().lower()
        self.list_widget.clear()
        for item in self.links:
            if query in item["title"].lower():
                widget = VideoItem(item["title"], item["date"], item["watched"], item["thumb_file"])
                list_item = QListWidgetItem()
                list_item.setSizeHint(widget.sizeHint())
                self.list_widget.addItem(list_item)
                self.list_widget.setItemWidget(list_item, widget)

# ---------------- Run ----------------
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = YouTubeWatchlist()
    window.show()
    sys.exit(app.exec())
